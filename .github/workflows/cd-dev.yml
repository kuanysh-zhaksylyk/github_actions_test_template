name: Dev Manual Deployment

on:
  workflow_dispatch:
    inputs:
      build-services:
        description: 'Build Project Services'
        required: false
        type: boolean
      update-platform:
        description: 'Update Platform'
        required: false
        type: boolean
      update-submodules:
        description: 'Update Platform Submodules'
        required: false
        type: boolean
      
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: ssh key passphrase
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.KEY }}
        port: ${{ secrets.PORT }}
        passphrase: ${{ secrets.PASSPHRASE }}
        script: |
          set -e
          cd ${{ secrets.WORK_DIR }}
          git status
          git stash
          git checkout develop
          git pull
          git stash pop || true        
          docker compose down
          
          if [ "${{ inputs.update-platform }}" = "true" ]; then
            ./scripts/install_submodules.sh update-platform
          fi
          
          if [ "${{ inputs.update-submodules }}" = "true" ]; then
            ./scripts/install_submodules.sh update-platform-submodules
          fi
        
          if [ "${{ inputs.build-services }}" = "true" ]; then
            docker compose build
          fi
          
          docker compose run --rm problem-solver build /kb/repo.path
          docker compose up -d
          docker compose ps
          docker compose logs --tail=100 
          exit
         
       